<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BRIN Digital Twin Parkir User</title>
    <link rel="icon" type="image/x-icon" href="https://github.com/Defdava/Digital-Twin-Website_user/blob/main/logo-brin.png?raw=true">
    <style>
        :root {
            --primary-blue: #1D3354;
            --accent-red: #D64045;
            --text-color: #FFFFFF;
            --white-bg: #E9FFF9;
            --slot-empty: #9ED8DB;
            --slot-occupied: #467599;
            --car-small: #0000FF;
            --car-medium: #FFA500;
            --car-big: #FF0000;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            overflow-x: hidden;
            font-size: 16px;
            touch-action: manipulation;
            background-color: var(--white-bg);
        }

        video#bg-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
            opacity: 0.2;
        }

        header {
            background-color: var(--primary-blue);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .logo {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .logo img {
            height: 50px;
        }

        .logo span {
            margin-left: 15px;
            font-size: 20px;
            font-weight: bold;
        }

        .header-right {
            display: flex;
            align-items: center;
            margin-left: auto;
            margin-right: 30px;
        }

        .header-right span {
            font-size: 18px;
        }

        .toolbar {
            position: fixed;
            top: 70px;
            left: -240px;
            width: 240px;
            height: calc(100vh - 70px);
            background-color: var(--primary-blue);
            padding: 15px 20px;
            z-index: 999;
            overflow-y: auto;
            transition: left 0.3s ease-in-out;
            box-sizing: border-box;
            color: white;
        }

        .toolbar.active {
            left: 0;
        }

        .toolbar .feature-box {
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid var(--accent-red);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .toolbar .feature-box h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: white;
            text-align: center;
        }

        .toolbar .feature-box button {
            width: 100%;
            padding: 10px;
            background-color: var(--accent-red);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 8px;
            transition: background-color 0.3s;
            font-weight: bold;
        }

        .toolbar .feature-box button:hover {
            background-color: #b8323a;
        }

        .toolbar .user-info {
            text-align: center;
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid var(--accent-red);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .toolbar .user-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid white;
        }

        .toolbar .user-info span {
            display: block;
            margin: 6px 0;
            font-size: 14px;
            color: white;
        }

        .main-content {
            padding: 90px 30px 30px;
            min-height: 100vh;
            margin-left: 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            transition: margin-left 0.3s ease-in-out;
        }

        .main-content.with-toolbar {
            margin-left: 260px;
        }

        .overview, .about-us, .user-details, .park-condition-2d {
            background-color: var(--slot-occupied);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--accent-red);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .overview h1, .about-us h1, .user-details h2, .park-condition-2d h2 {
            margin: 0 0 15px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .stats div {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }

        .stats span:first-child {
            display: block;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .stats span:last-child {
            font-size: 16px;
            font-weight: bold;
        }

        .about-us .content {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--accent-red);
            text-align: center;
        }

        .about-us img {
            width: 100%;
            max-width: 150px;
            height: auto;
            border: 2px solid white;
            border-radius: 8px;
            margin: 10px auto;
            display: block;
        }

        .about-us p {
            font-size: 13px;
            line-height: 1.6;
            text-align: justify;
            margin: 10px 0;
        }

        .about-us a button {
            background-color: var(--accent-red);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .about-us a button:hover {
            background-color: #b8323a;
        }

        .user-details .detail {
            margin-bottom: 15px;
        }

        .user-details label {
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .user-details input,
        .user-details select,
        .user-details textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--accent-red);
            border-radius: 6px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            box-sizing: border-box;
        }

        .user-details input::placeholder,
        .user-details textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .user-details input:focus,
        .user-details select:focus,
        .user-details textarea:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
        }

        .user-details .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .user-details .actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .in-btn {
            background-color: #28a745;
        }

        .in-btn:hover {
            background-color: #218838;
        }

        .out-btn {
            background-color: #dc3545;
        }

        .out-btn:hover {
            background-color: #c82333;
        }

        .parking-lot {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }

        .column {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .slot {
            width: 50px;
            height: 50px;
            background-color: var(--slot-empty);
            border: 2px solid var(--accent-red);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .slot.occupied {
            background-color: yellow;
        }

        .slot .car {
            width: 35px;
            height: 20px;
            border-radius: 4px;
            position: absolute;
            display: none;
            animation: carEnter 0.5s ease-in-out;
        }

        .slot.occupied .car {
            display: block;
        }

        @keyframes carEnter {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes carExit {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(0); opacity: 0; }
        }

        .slot.occupied.exiting .car {
            animation: carExit 0.5s ease-in-out forwards;
        }

        #error-message {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(214, 64, 69, 0.9);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 1001;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .tour-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            pointer-events: none;
        }

        .tour-tooltip {
            position: absolute;
            background-color: var(--primary-blue);
            border: 2px solid var(--accent-red);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            pointer-events: auto;
            animation: fadeIn 0.3s ease-in-out;
            z-index: 2001;
        }

        .tour-tooltip h3 {
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .tour-tooltip p {
            font-size: 14px;
            color: white;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .tour-tooltip .tour-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .tour-tooltip button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .tour-tooltip .next-btn {
            background-color: var(--accent-red);
            color: white;
        }

        .tour-tooltip .next-btn:hover {
            background-color: #b8323a;
        }

        .tour-tooltip .close-btn {
            background-color: #b8323a;
            color: white;
        }

        .tour-tooltip .close-btn:hover {
            background-color: #c82333;
        }

        .tour-tooltip:after {
            content: "";
            position: absolute;
            border: 10px solid transparent;
            pointer-events: none;
        }

        .tour-tooltip.right:after { border-right-color: var(--accent-red); left: -20px; top: 50%; transform: translateY(-50%); }
        .tour-tooltip.left:after { border-left-color: var(--accent-red); right: -20px; top: 50%; transform: translateY(-50%); }
        .tour-tooltip.top:after { border-top-color: var(--accent-red); bottom: -20px; left: 50%; transform: translateX(-50%); }
        .tour-tooltip.bottom:after { border-bottom-color: var(--accent-red); top: -20px; left: 50%; transform: translateX(-50%); }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 768px) {
            body { font-size: 9px; }
            header { padding: 4px 6px; }
            .logo img { height: 25px; }
            .logo span { font-size: 10px; margin-left: 4px; }
            .header-right span { font-size: 9px; }
            .toolbar { width: 100%; left: -100%; top: 70px; }
            .main-content { padding: 49px 6px 6px; grid-template-columns: 1fr; gap: 10px; }
            .main-content.with-toolbar { margin-left: 0; }
            .overview, .about-us, .user-details, .park-condition-2d { padding: 10px; }
            .overview h1, .about-us h1, .user-details h2, .park-condition-2d h2 { font-size: 12px; }
            .stats { grid-template-columns: 1fr; }
            .stats div { padding: 6px; font-size: 9px; }
            .about-us img { max-width: 80px; }
            .about-us p { font-size: 8px; }
            .user-details input, .user-details select, .user-details textarea { padding: 6px; font-size: 9px; }
            .user-details .actions button { padding: 8px; font-size: 10px; }
            .slot { width: 35px; height: 35px; font-size: 10px; }
            .slot .car { width: 25px; height: 14px; }
            #error-message { top: 49px; padding: 6px 10px; font-size: 9px; }
            .tour-tooltip { max-width: 70%; padding: 8px; }
            .tour-tooltip h3 { font-size: 10px; }
            .tour-tooltip p { font-size: 8px; }
            .tour-tooltip button { padding: 4px 6px; font-size: 8px; }
        }
    </style>
</head>
<body>
    <video id="bg-video" autoplay muted loop>
        <source src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/wave.mp4?raw=true" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <header>
        <div class="logo" id="toggleToolbar">
            <img src="https://github.com/Defdava/BRIN_Operator_DigitalTwin/blob/46a20c237c763bc2ccd436c332785427771eea05/public/brin_logo.png?raw=true" alt="BRIN Logo">
            <span>BRIN</span>
            <span>Badan Riset dan Inovasi Nasional</span>
        </div>
        <div class="header-right">
            <span>Parking Management System</span>
        </div>
    </header>

    <aside class="toolbar" id="toolbar">
        <div class="feature-box user-info" id="userInfo">
            <h3>User</h3>
            <img id="profilePic" src="/assets/user.JPG" alt="User">
            <span>Welcome Back</span>
            <span id="userName"></span>
            <button class="profile" onclick="window.location.href='profile.html'">Profile</button>
            <button class="form-message" onclick="window.location.href='index.html'">Form Message</button>
            <button class="logout">Log Out</button>
        </div>
        <div class="feature-box live-overview">
            <h3>Live Overview</h3>
            <div class="status">
                <span id="availableSpots">0</span> Available Parking Spots
            </div>
            <div class="status">
                <span id="occupiedSpots">0</span> Occupied Parking Spots
            </div>
            <div class="status">
                Last Activity: <span id="lastActivity">None</span>
            </div>
            <button onclick="refreshOverview()">Refresh</button>
        </div>
    </aside>

    <main class="main-content" id="mainContent">
        <div id="error-message"></div>

        <div class="about-us">
            <h1>About Us</h1>
            <div class="content">
                <img src="https://github.com/Defdava/Digital-Twin-Website-used/blob/main/Logo_BRIN.png?raw=true" alt="BRIN Logo">
                <p>BRIN Cisitu Bandung merupakan salah satu kawasan riset milik Badan Riset dan Inovasi Nasional yang berlokasi di Kawasan Sains dan Teknologi Samaun Samadikun, Jalan Sangkuriang, Dago, Kecamatan Coblong, Bandung. Kawasan ini menjadi pusat berbagai kegiatan penelitian dan inovasi, termasuk pengembangan kecerdasan artifisial, keamanan siber, dan teknologi telekomunikasi.</p>
                <a href="aboutus.html"><button>More Details</button></a>
            </div>
        </div>

        <div class="overview">
            <h1>Live Overview</h1>
            <div class="stats">
                <div><span>Cars</span><span id="occupiedSlots">0 / 20</span></div>
                <div><span>Slots</span><span id="emptySlots">20 / 20</span></div>
                <div><span>Time</span><span id="currentTime"></span></div>
                <div><span>Loyalty Customers</span><span>3</span></div>
                <div><span>Total Cars In</span><span id="totalCarsIn">0 Today</span></div>
                <div><span>Total Cars Out</span><span id="totalCarsOut">0 Today</span></div>
            </div>
        </div>

        <div class="user-details">
            <h2>Form Message Parking</h2>
            <div class="detail">
                <label for="detailName">Nama:</label>
                <input type="text" id="detailName" readonly>
            </div>
            <div class="detail">
                <label for="detailIdWorker">ID Karyawan:</label>
                <input type="text" id="detailIdWorker" readonly>
            </div>
            <div class="detail">
                <label for="detailPlate">Plat Nomor Mobil:</label>
                <input type="text" id="detailPlate" readonly>
            </div>
            <div class="detail">
                <label for="parkingDate">Tanggal:</label>
                <input type="date" id="parkingDate">
            </div>
            <div class="detail">
                <label for="contactNumber">Nomor Kontak:</label>
                <input type="tel" id="contactNumber" placeholder="Masukkan nomor kontak">
            </div>
            <div class="detail">
                <label for="parkingNotes">Catatan Parkir:</label>
                <textarea id="parkingNotes" placeholder="Masukkan catatan parkir" rows="3"></textarea>
            </div>
            <div class="detail">
                <label for="slotSelect">Pilih Slot Parkir:</label>
                <select id="slotSelect">
                    <option value="">-- Pilih Slot --</option>
                </select>
            </div>
            <div class="actions">
                <button class="in-btn">Mobil Masuk</button>
                <button class="out-btn">Mobil Keluar</button>
            </div>
        </div>

        <div class="park-condition-2d">
            <h2>Park Condition (2D)</h2>
            <div class="parking-lot">
                <div class="column top">
                    <div class="slot" data-slot="20"><span>20</span><div class="car"></div></div>
                    <div class="slot" data-slot="19"><span>19</span><div class="car"></div></div>
                    <div class="slot" data-slot="18"><span>18</span><div class="car"></div></div>
                    <div class="slot" data-slot="17"><span>17</span><div class="car"></div></div>
                    <div class="slot" data-slot="16"><span>16</span><div class="car"></div></div>
                    <div class="slot" data-slot="15"><span>15</span><div class="car"></div></div>
                    <div class="slot" data-slot="14"><span>14</span><div class="car"></div></div>
                    <div class="slot" data-slot="13"><span>13</span><div class="car"></div></div>
                    <div class="slot" data-slot="12"><span>12</span><div class="car"></div></div>
                </div>
                <div class="column bottom">
                    <div class="slot" data-slot="11"><span>11</span><div class="car"></div></div>
                    <div class="slot" data-slot="10"><span>10</span><div class="car"></div></div>
                    <div class="slot" data-slot="9"><span>9</span><div class="car"></div></div>
                    <div class="slot" data-slot="8"><span>8</span><div class="car"></div></div>
                    <div class="slot" data-slot="7"><span>7</span><div class="car"></div></div>
                    <div class="slot" data-slot="6"><span>6</span><div class="car"></div></div>
                    <div class="slot" data-slot="5"><span>5</span><div class="car"></div></div>
                    <div class="slot" data-slot="4"><span>4</span><div class="car"></div></div>
                    <div class="slot" data-slot="3"><span>3</span><div class="car"></div></div>
                    <div class="slot" data-slot="2"><span>2</span><div class="car"></div></div>
                    <div class="slot" data-slot="1"><span>1</span><div class="car"></div></div>
                </div>
            </div>
        </div>

        <div class="tour-overlay" id="tourOverlay"></div>
        <div class="tour-tooltip" id="tourTooltip" style="display: none;">
            <h3 id="tooltipTitle"></h3>
            <p id="tooltipText"></p>
            <div class="tour-buttons">
                <button class="next-btn" id="tourNextBtn">Next</button>
                <button class="close-btn" id="tourCloseBtn">Close</button>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAef3SJwvVVTunr6CWki79aenfpXlgYc0s",
            authDomain: "digitaltwinparkingbrin.firebaseapp.com",
            databaseURL: "https://digitaltwinparkingbrin-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "digitaltwinparkingbrin",
            storageBucket: "digitaltwinparkingbrin.appspot.com",
            messagingSenderId: "608462498913",
            appId: "1:608462498913:web:73695d8c91f923e2db8e20"
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database().ref("slot_parking");
        const slotHistoryRef = firebase.database().ref("slot_history");
        let slotSizes = {};

        // Show Error
        function showError(message) {
            const el = document.getElementById('error-message');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // Update Parking Lot
        function updateParkingLot(data) {
            const totalSlots = 20;
            let occupiedCount = 0;
            for (let i = 1; i <= totalSlots; i++) {
                const slotKey = `slot_${i}`;
                const slotEl = document.querySelector(`.slot[data-slot="${i}"]`);
                const isOccupied = data[slotKey]?.occupied === true;
                const size = data[slotKey]?.size ? data[slotKey].size.toLowerCase() : 'none';
                slotSizes[slotKey] = size;

                if (slotEl) {
                    if (isOccupied) {
                        slotEl.classList.add("occupied");
                        const car = slotEl.querySelector(".car");
                        car.style.display = "block";
                        car.style.backgroundColor = 
                            size === 'small' ? "#0000FF" :
                            size === 'medium' ? "#FFA500" :
                            size === 'big' ? "#FF0000" : "#808080";
                        occupiedCount++;
                    } else {
                        slotEl.classList.remove("occupied");
                        slotEl.querySelector(".car").style.display = "none";
                    }
                }
            }
            const emptyCount = totalSlots - occupiedCount;
            document.getElementById('availableSpots').textContent = emptyCount;
            document.getElementById('occupiedSpots').textContent = occupiedCount;
            document.getElementById('lastActivity').textContent = data.lastActivity || 'None';
            document.getElementById('occupiedSlots').textContent = `${occupiedCount} / ${totalSlots}`;
            document.getElementById('emptySlots').textContent = `${emptyCount} / ${totalSlots}`;
        }

        // Setup Firebase
        function setupFirebaseListener() {
            dbRef.on("value", (snapshot) => {
                const data = snapshot.val() || {};
                updateParkingLot(data);

                slotHistoryRef.on("value", (historySnapshot) => {
                    const historyData = historySnapshot.val();
                    if (!historyData) return;
                    const today = new Date().toISOString().split('T')[0];
                    let totalIn = 0, totalOut = 0;
                    Object.values(historyData).forEach(slotLogs => {
                        Object.values(slotLogs).forEach(entry => {
                            const entryDate = entry.timestamp.split(' ')[0];
                            if (entryDate === today) {
                                if (entry.status === 'terisi') totalIn++;
                                else if (entry.status === 'kosong') totalOut++;
                            }
                        });
                    });
                    document.getElementById('totalCarsIn').textContent = `${totalIn} Today`;
                    document.getElementById('totalCarsOut').textContent = `${totalOut} Today`;
                });
            });
        }

        // Send Message
        function sendSlotMessage(slotKey, action, user) {
            if (!slotKey) return showError('Pilih slot parkir terlebih dahulu!');
            const timestamp = new Date().toLocaleString('en-US', { timeZone: 'Asia/Jakarta' });
            const updates = {};
            updates[`slot_parking/${slotKey}/occupied`] = action === 'Mobil Masuk';
            updates[`slot_parking/${slotKey}/size`] = slotSizes[slotKey] || 'none';
            updates[`slot_parking/lastActivity`] = `${action} at ${timestamp}`;
            updates[`slot_message_user/${slotKey}`] = {
                lastAction: action,
                user: user.username,
                idWorker: user.idWorker,
                plate: user.plateNumber || 'None',
                contactNumber: document.getElementById('contactNumber').value || 'None',
                parkingNotes: document.getElementById('parkingNotes').value || 'None',
                date: document.getElementById('parkingDate').value,
                timestamp: timestamp,
                size: slotSizes[slotKey] || 'none'
            };
            updates[`slot_history/${slotKey}/${timestamp}`] = {
                status: action === 'Mobil Masuk' ? 'terisi' : 'kosong',
                size: slotSizes[slotKey] || 'none',
                timestamp: timestamp
            };
            firebase.database().ref().update(updates).then(() => {
                showError(`${action} untuk ${slotKey} berhasil dikirim!`);
                document.getElementById('contactNumber').value = '';
                document.getElementById('parkingNotes').value = '';
            }).catch(() => showError('Gagal mengirim pesan.'));
        }

        // Tour
        const tourSteps = [
            { element: '.about-us', title: "Tentang Perusahaan", text: "Ini adalah bagian About Us yang menjelaskan tentang BRIN Cisitu Bandung sebagai pusat riset dan inovasi.", position: 'right' },
            { element: '.overview', title: "Live Overview", text: "Statistik parkir real-time: mobil masuk/keluar, slot kosong, waktu, dll.", position: 'left' },
            { element: '.user-details', title: "Form Message Parking", text: "Isi data dan pilih slot, lalu klik 'Mobil Masuk' atau 'Keluar'.", position: 'right' },
            { element: '.park-condition-2d', title: "Park Condition 2D", text: "Slot kuning = terisi. Warna mobil: biru (kecil), kuning (sedang), merah (besar).", position: 'left' }
        ];
        let currentTourStep = 0;
        let hasSeenTour = false;

        function startTour() {
            if (hasSeenTour) return;
            document.getElementById('tourOverlay').style.display = 'block';
            showTooltip(currentTourStep);
        }
        function showTooltip(step) {
            const tooltip = document.getElementById('tourTooltip');
            const title = document.getElementById('tooltipTitle');
            const text = document.getElementById('tooltipText');
            const nextBtn = document.getElementById('tourNextBtn');
            const target = document.querySelector(tourSteps[step].element);
            if (!target) return endTour();

            title.textContent = tourSteps[step].title;
            text.textContent = tourSteps[step].text;
            tooltip.style.display = 'block';
            tooltip.className = 'tour-tooltip ' + tourSteps[step].position;

            const rect = target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            let left, top;
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                left = (window.innerWidth - tooltipRect.width) / 2;
                top = rect.bottom + 10;
                tooltip.className = 'tour-tooltip bottom';
            } else {
                switch (tourSteps[step].position) {
                    case 'right': left = rect.right + 10; top = rect.top + (rect.height / 2) - (tooltipRect.height / 2); break;
                    case 'left': left = rect.left - tooltipRect.width - 10; top = rect.top + (rect.height / 2) - (tooltipRect.height / 2); break;
                    case 'top': left = rect.left + (rect.width / 2) - (tooltipRect.width / 2); top = rect.top - tooltipRect.height - 10; break;
                    case 'bottom': left = rect.left + (rect.width / 2) - (tooltipRect.width / 2); top = rect.bottom + 10; break;
                }
            }
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            nextBtn.textContent = step === tourSteps.length - 1 ? 'Finish' : 'Next';
        }
        function endTour() {
            document.getElementById('tourOverlay').style.display = 'none';
            document.getElementById('tourTooltip').style.display = 'none';
            currentTourStep = 0;
            hasSeenTour = true;
            localStorage.setItem('tourCompleted_user', 'true');
        }

        // DOM Loaded
        document.addEventListener("DOMContentLoaded", () => {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) {
                alert('Silakan login terlebih dahulu!');
                window.location.replace('login.html');
                return;
            }

            hasSeenTour = localStorage.getItem('tourCompleted_user') === 'true';

            // Setup UI
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('profilePic').src = currentUser.profilePic || '/assets/user.JPG';
            document.getElementById('detailName').value = currentUser.username;
            document.getElementById('detailIdWorker').value = currentUser.idWorker;
            document.getElementById('detailPlate').value = currentUser.plateNumber || 'None';
            document.getElementById('parkingDate').value = new Date().toISOString().split('T')[0];

            // Populate Slot Select
            const slotSelect = document.getElementById('slotSelect');
            for (let i = 1; i <= 20; i++) {
                const opt = document.createElement('option');
                opt.value = `slot_${i}`;
                opt.textContent = `Slot ${i}`;
                slotSelect.appendChild(opt);
            }

            // Toolbar
            document.getElementById('toggleToolbar').addEventListener('click', () => {
                document.getElementById('toolbar').classList.toggle('active');
                document.getElementById('mainContent').classList.toggle('with-toolbar');
            });

            // Logout
            document.querySelector('.logout').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.replace('login.html');
            });

            // Clock
            function updateClock() {
                const now = new Date();
                const options = { timeZone: 'Asia/Jakarta', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: false };
                document.getElementById('currentTime').textContent = new Intl.DateTimeFormat('en-US', options).format(now) + ' WIB';
            }
            updateClock();
            setInterval(updateClock, 1000);

            // Firebase
            setupFirebaseListener();

            // Buttons
            document.querySelector('.in-btn').addEventListener('click', () => {
                sendSlotMessage(document.getElementById('slotSelect').value, 'Mobil Masuk', currentUser);
            });
            document.querySelector('.out-btn').addEventListener('click', () => {
                sendSlotMessage(document.getElementById('slotSelect').value, 'Mobil Keluar', currentUser);
            });

            // Tour
            document.getElementById('tourNextBtn').addEventListener('click', () => {
                currentTourStep++;
                if (currentTourStep < tourSteps.length) showTooltip(currentTourStep);
                else endTour();
            });
            document.getElementById('tourCloseBtn').addEventListener('click', endTour);

            if (!hasSeenTour) setTimeout(startTour, 800);

            // Prevent Undo/Redo
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && (e.key === 'z' || e.key === 'y')) e.preventDefault();
            });
        });
    </script>
</body>
</html>